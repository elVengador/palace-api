(()=>{var e,r,t,n={18967:e=>{function r(e){var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=18967,e.exports=r},18691:(e,r,t)=>{"use strict";var n=t(40096);t(59738).config();const s=process.env.DB_MONGODB_HOST,a=process.env.DB_MONGODB_PORT,o=process.env.DB_MONGODB_USER,i=process.env.DB_MONGODB_PASS,u=process.env.DB_MONGODB_NAME,c=process.env.DB_REDIS_HOST,p=process.env.DB_REDIS_PORT,d=process.env.ACCESS_TOKEN_SECRET,l=process.env.REFRESH_TOKEN_SECRET;let g=null;const I=e=>g.db(u).collection(e);(async()=>{try{const e=`mongodb://${o}:${i}@${s}:${a}?retryWrites=true&w=majority`;g=new n.MongoClient(e,{useUnifiedTopology:!0},{useNewUrlParser:!0}),await g.connect(),console.log("[💽 MongoDB]: connected successfull")}catch(e){console.error("-- >>",e)}})();const f=(0,t(25693).createClient)({url:`redis://${c}:${p}`}),w=f;(async()=>{await f.connect(),console.log("[💽 Redis]: connected successfull")})();var y=t(89135),h=t(38137),v=t(13685),T=t.n(v),S=t(99268),O=t(17846),m=t.n(O),E=t(10046),x=t.n(E);const q=S();q.use(x().urlencoded({extended:!1})),q.use(x().json()),q.use(m()()),q.get("/",((e,r)=>r.send("🚀")));const _=e=>new Error(e),D=e=>new Error("Field invalid"),k=()=>new Error("Unauthorized"),b=()=>new Error("Server Error"),R=e=>((e=>{console.log(`[🔥 Error]: ${e.message}`)})(e),e.message.startsWith("Database Error: ")?new Error("Internal server error"):{message:e.message});var N=t(10858),B=t(49704),U=t.n(B);const M=({userId:e,rol:r,aud:t="app"})=>new Promise(((n,s)=>{const a={rol:r,aud:t,sub:e},o=d;U().sign(a,o,{expiresIn:"15m",issuer:"vauth"},((e,r)=>e?s(new Error(e)):r?void n(r):s(new Error("Server error at"))))})),P=({userId:e,aud:r="app"})=>new Promise(((t,n)=>{const s={aud:r,sub:e},a=l;U().sign(s,a,{expiresIn:"30 days",issuer:"vauth"},((e,r)=>{if(e||!r)return n(new Error("Invalid"));t(r)}))})),$=({refreshToken:e})=>new Promise(((r,t)=>{try{U().verify(e,l,((e,t)=>{if(e)throw new Error;return r(t.sub)}))}catch(e){return t(new Error("Not authorization"))}}));console.log("=== === =>>");const A=async({userId:e,token:r,expiration:t})=>await w.set(e,r,"EX",t),j=async({userId:e})=>await w.get(e),C=31536e3,G={...{signUp:async(e,{signUpInput:r})=>{try{const{nick:e,email:t,password:n}=r;console.log("ARG:",e,t,n);const s=await(async({email:e})=>await I("users").findOne({email:e}))({email:t});if(s)return _("Email ya esta en uso");let a={nick:"",phone:"",email:"",password:"",name:"",paternalLastName:"",maternalLastName:"",dni:"",birthday:"",photo:null,state:""};return a.nick=e,a.email=t,a.password=await(async({password:e})=>{const r=await N.genSalt(11);return await N.hash(e,r)})({password:n}),await(async e=>(await I("users").insertOne(e)).insertedId)(a)}catch(e){return console.log(e),b()}},signIn:async(e,{signInInput:r})=>{try{console.log("sign in");const{email:e,password:t}=r,n=await(async({email:e})=>await I("users").findOne({email:e}))({email:e});if(!n)return D();const s=await(async({password:e,user:r})=>await N.compare(e,r.password))({password:t,user:n});if(!s)return D();const a=await M({userId:n._id,rol:n.rol||"dev"}),o=await P({userId:n._id});return await A({userId:n._id.toString(),token:o,expiration:C}),{accessToken:a,refreshToken:o}}catch(e){return b()}},signOff:async({signOffInput:e})=>{try{const{currentRefreshToken:r}=e;if(!r)return k();const t=await $({refreshToken:r});return r!==await j({userId:t})?k():(await(async({userId:e})=>await w.del(e))({userId:t}),!0)}catch(e){return b()}},refreshToken:async(e,{refreshTokenInput:r})=>{try{const{currentRefreshToken:e,retryNumber:t}=r;if(t>1)return _("MANY_TRYS");if(!e)return new Error("Bad Request");console.log(" REFRESH_TOKEN:",e);const n=await $({refreshToken:e});if(e!==await j({userId:n}))return k();const s=await M({userId:n,rol:"dev"}),a=await P({userId:n});return await A({userId:n,token:a,expiration:C}),{accessToken:s,refreshToken:a}}catch(e){return b()}},privateContent:async()=>{try{return"Hi man you got access to private content"}catch(e){return b()}}}},H="tags",L={addTag:async(e,{addTagInput:r},t)=>{try{const e=t.userId;if(!e)return k();const n={userId:null,value:"",state:"ENABLE",updateDate:(new Date).toISOString(),creationDate:(new Date).toISOString()};n.userId=e,n.value=r.value;const s=await(async e=>(await I(H).insertOne(e)).insertedId)(n);return await(async({tagId:e})=>await I(H).findOne({_id:e}))({tagId:s})}catch(e){return b()}},updateTag:async(e,{tagId:r,updateTagInput:t},s)=>{try{if(!s.userId)return k();const e={...t};return e.updateDate=(new Date).toISOString(),await(async({tagId:e,newTag:r})=>(await I(H).findOneAndUpdate({_id:new n.ObjectId(e)},{$set:r},{returnDocument:"after"})).value)({tagId:r,newTag:e})}catch(e){return b()}}},z={getTagsByUser:async(e,{getTagsByUser:r},t)=>{try{const e=t.userId;return e?await(async({userId:e})=>{const r=I(H).find({userId:e});return await r.toArray()})({userId:e}):k()}catch(e){return console.log(e),b()}}};(async(e,r,t)=>{const n=T().createServer(q),s=new h.fv({typeDefs:e,resolvers:r,introspection:!0,plugins:[(0,y.ApolloServerPluginDrainHttpServer)({httpServer:n}),{async requestDidStart(e){console.log("[📝 Log]:",e.request.operationName)}}],formatError:R,context:async({req:e})=>{try{console.log("[💾 Context]");const r=e.headers.authorization||"";if(!r)return{userId:null};const t=r.split(" ")[1],n=await(e=>new Promise(((r,t)=>{try{U().verify(e,d,((e,n)=>e&&"JsonWebTokenError"===e?.name||e&&"TokenExpiredError"===e?.name?r(null):e?t(b()):r(n.sub)))}catch(e){return console.log("ERR_GET_USER_BY_TOKEN:",e),t(b())}})))(t);return{userId:n}}catch(e){return{userId:null}}}});await s.start(),s.applyMiddleware({app:q,path:"/graphql"}),await new Promise((e=>n.listen({port:4100},e))),console.log(`[📡 Server]: ready at http://localhost:4100${s.graphqlPath}`)})(y.gql`
    ${"\n    #graphql\n    \n    input SignUpInput{\n        nick:String!,\n        email:String!,\n        password:String!\n    }\n\n    input SignInInput{\n        email:String!,\n        password:String!\n    }\n\n    input SignOffInput{\n        currentRefreshToken:String!\n    }\n\n    input RefreshTokenInput{\n        currentRefreshToken:String!,\n        retryNumber:Int!,\n    }\n\n    type TokensOutput{\n        accessToken:String,\n        refreshToken:String\n    }\n\n"}
    ${"#graphql\n    type Tag {\n        _id:ID!\n        userId: ID!\n        value: String!\n        state: String!\n        updateDate: String!\n        creationDate: String!\n    }\n\n    input AddTagInput{\n        value: String!\n    }\n\n    input UpdateTagInput{\n        value: String!\n    }\n"}
    type Query {${"\n    \n    #graphql\n    # getMedia(id:ID!): Media\n    hola:String\n\n\n    #graphql\n    getTagsByUser: [Tag]\n\n"}}
    type Mutation {${"\n    \n    #graphql\n    signUp(signUpInput:SignUpInput!):String\n    signIn(signInInput:SignInInput!):TokensOutput\n    signOff(signOffInput:SignOffInput!):Boolean\n    refreshToken(refreshTokenInput:RefreshTokenInput!):TokensOutput\n    privateContent:String\n\n\n    #graphql\n    addTag(addTagInput:AddTagInput):Tag\n    updateTag(tagId:ID!,updateTagInput:UpdateTagInput!):Tag\n    # removeTag(tagId:ID!):Int\n\n"}}
  `,{Query:{hola:()=>"Hi",...z},Mutation:{...G,...L}})},39491:e=>{"use strict";e.exports=require("assert")},14300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},9523:e=>{"use strict";e.exports=require("dns")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},85477:e=>{"use strict";e.exports=require("punycode")},63477:e=>{"use strict";e.exports=require("querystring")},12781:e=>{"use strict";e.exports=require("stream")},71576:e=>{"use strict";e.exports=require("string_decoder")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")}},s={};function a(e){var r=s[e];if(void 0!==r)return r.exports;var t=s[e]={id:e,loaded:!1,exports:{}};return n[e].call(t.exports,t,t.exports,a),t.loaded=!0,t.exports}a.m=n,a.x=()=>{var e=a.O(void 0,[939],(()=>a(18691)));return a.O(e)},e=[],a.O=(r,t,n,s)=>{if(!t){var o=1/0;for(p=0;p<e.length;p++){for(var[t,n,s]=e[p],i=!0,u=0;u<t.length;u++)(!1&s||o>=s)&&Object.keys(a.O).every((e=>a.O[e](t[u])))?t.splice(u--,1):(i=!1,s<o&&(o=s));if(i){e.splice(p--,1);var c=n();void 0!==c&&(r=c)}}return r}s=s||0;for(var p=e.length;p>0&&e[p-1][2]>s;p--)e[p]=e[p-1];e[p]=[t,n,s]},a.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return a.d(r,{a:r}),r},a.d=(e,r)=>{for(var t in r)a.o(r,t)&&!a.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((r,t)=>(a.f[t](e,r),r)),[])),a.u=e=>e+".js",a.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),t={826:1},a.O.require=e=>t[e],a.f.require=(e,r)=>{t[e]||(e=>{var r=e.modules,n=e.ids,s=e.runtime;for(var o in r)a.o(r,o)&&(a.m[o]=r[o]);s&&s(a);for(var i=0;i<n.length;i++)t[n[i]]=1;a.O()})(require("./"+a.u(e)))},r=a.x,a.x=()=>(a.e(939),r()),a.x()})();